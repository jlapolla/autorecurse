# Autorecurse

## Introduction

`autorecurse` is a wrapper around the `make` utility that allows the
user to split a large makefile into many smaller makefiles distributed
throughout a directory and its subdirectories. Makefiles in
subdirectories are called **nested makefiles**. Splitting the build
among multiple makefiles creates a modular build system that is easier
to maintain, since each nested makefile is only responsible for building
the targets in its subdirectory.

### But I can already do that with recursive makefiles

Some `make` utilities provide a way to divide a makefile into separate
subsystems. For example, GNU Make allows a top level makefile to define
rules which call `make` recursively in subdirectories [\[15\]][15].

However, this requires the user to manually add recursive rules to the
top level makefile. With `autorecurse`, the user does not have to add
recursive rules to their top level makefile. `autorecurse` also solves
the **hidden prerequisite problem** that occurs when you use native
`make` recursion.

### The Hidden Prerequisite Problem

Consider the following C project:

```
MusicPlayer/
  Makefile
  Program.exe
  Program.c
  Filters/
    Makefile
    Filters.a
    Filters.c
```

The contents of the makefiles are:

```
# MusicPlayer/Makefile

Program.exe: Program.c Filters/Filters.a
        # Commands to build Program.exe

Filters/Filters.a:
        # Recursive `make` call
        $(MAKE) -C Filters Filters.a
```

```
# MusicPlayer/Filters/Makefile

Filters.a: Filters.c
        # Commands to build Filters.a
```

When we run `make Program.exe` from the `MusicPlayer/` directory, `make`
builds `Filters.a` and `Program.exe`. However, if we modify `Filters.c`
and re-run `make Program.exe`, `make` does not rebuild `Filters.a` even
though we updated `Filters.c`. Why? Because the top level makefile does
not say that `Filters.a` depends on `Fitlers.c`. In fact, the top level
makefile specifically says `Fitlers.a` has no prerequisites. As long as
`Filters.a` exists, `make` will not recurse into the `Filters`
subdirectory, so it will never know that `Filters.a` actually depends on
`Filters.c`, and it will never rebuild `Filters.a`.

`Filters.c` is a **hidden prerequisite** of `Filters.a`.

### Solving the Hidden Prerequisite Problem

When we wrap `make` with `autorecurse`, the C project above looks like
this (only the makefile contents have changed):

```
MusicPlayer/
  Makefile
  Program.exe
  Program.c
  Filters/
    Makefile
    Filters.a
    Filters.c
```

The contents of the makefiles are:

```
# MusicPlayer/Makefile

Program.exe: Program.c Filters/Filters.a
        # Commands to build Program.exe
```

```
# MusicPlayer/Filters/Makefile

Filters.a: Filters.c
        # Commands to build Filters.a
```

*Note: For this example, we'll say the "wrapped" version of `make` is
invoked as `maker`.*

When we run `maker Program.exe` from the `MusicPlayer/` directory,
`autorecurse` searches for nested makefiles in `MusicPlayer/` and its
subdirectories. `autorecurse` finds `MusicPlayer/Fitlers/Makefile`, and
analyzes its contents. Then `autorecurse` constructs a new makefile
(called a **nested rule file**) which captures the dependencies among
the targets in all nested makefiles. Finally, `autorecurse` calls `make`
on a combination of the original makefile, **and** the new nested rule
file. Now the top level `make` knows that `Filters.a` depends on
`Filters.c` because the nested rule file says so.

*Note: The nested rule file is an auxilliary makefile that is
automatically generated by `autorecurse`.*

Also notice that the user does not have to define a recursive rule in
`MusicPlayer/Makefile`. They can directly use `Filters/Filters.a` as a
prerequisite. `autorecurse` inserts the recursive rule in the nested
rule file.

## Installation

**TO BE DECIDED**

## Compatibility

### Supported Operating Systems

Currently, `autorecurse` supports Linux-like operating systems
(including Cygwin). `autorecurse` would like to support other operating
systems if there is user demand. Cast your vote by creating an issue on
Github.

### Supported `make` Variants

Currently, `autorecurse` supports GNU Make. `autorecurse` would like to
support other `make` variants (e.g. BSD Make, Microsoft NMake) if there
is user demand for these variants. Cast your vote by creating an issue
on Github.

#### GNU Make

For detailed documentation on what goes on under the hood when
`autorecurse` uses GNU Make, see
`python3/autorecurse/gnumake/README.md`.

### Supported Python Versions

Currently, `autorecurse` requires Python 3.5 or higher.

### User File Locations

`autorecurse` stores configuration and other data specific to each user
on a machine. This section describes where that data resides.

#### Symbolic Locations

`autorecurse` stores its data in different locations based on the
machine's operating system and the specific variant of `autorecurse`.
For portability, `autorecurse` internally uses symbolic locations.
Symbolic locations are mapped to real locations based on the current
operating system.

This section describes the symbolic locations. The following sections
map each symbolic location to a real location for a particular operating
system. The real location is often a file or folder in the file system,
but this is not always the case. For instance, some data may be stored
in the Windows registry or GConf.

The symbolic locations are:

- `AUTORECURSE_USRLOCAL`: User and machine configuration values. These
  values are customized by the user. These values should be backed up on
  operating systems with built-in backup support. Note that these values
  are not **roaming** (i.e. they are not synced across user devices
  running the same operating system).
- `AUTORECURSE_USRLOCALCACHE`: Cached values created by `autorecurse` on
  the user's behalf. `autorecurse` can automatically generate these
  values again when it needs them. The values in
  `AUTORECURSE_USRLOCALCACHE` help `autorecurse` execute faster on
  subsequent invocations. These values may be deleted, and need not be
  backed up on operating systems with built-in backup support.
- `AUTORECURSE_USRTMP`: Folder for temporary files used by
  `autorecurse`. Files in this folder are deleted before `autorecurse`
  finishes executing. `AUTORECURSE_USRTMP` is typically mapped to a
  system-wide temporary file system so files here will eventually be
  deleted by the operating system if `autorecurse` fails to delete them.
  This is considered a user folder because files here are generated by a
  particular user running `autorecurse`.

#### Linux

- `AUTORECURSE_USRLOCAL` = `~/.autorecurse/local`
- `AUTORECURSE_USRLOCALCACHE` = `~/.cache/autorecurse` [\[1\]][1]
- `AUTORECURSE_USRTMP` = `~/.autorecurse/tmp`

#### Windows

**TO BE DECIDED**

#### OS X

**TO BE DECIDED**

### System File Locations

`autorecurse` does not store any configuration or other data meant for
use by all users on a machine.

# Links Index

- [Linux application file guidelines][1]

- [Windows application file guildelines][12]
- [Windows roaming guidelines][11]
- [Python wrapper for Windows KNOWNFOLDERID][6]
- [Windows KNOWNFOLDERID list][2]
- [Windows CSIDL list (like KNOWNFOLDERID for Windows XP)][3]
- [Windows XP special folders][10]
- [Windows UWP application data][5]
- [Windows special folders list on Wikipedia][4]
- [Windows registry versus files][13]

- [Registry versus files thread][14]

[1]: http://www.linux.org/threads/temporary-files.7099/
[2]: https://msdn.microsoft.com/en-us/library/windows/desktop/dd378457.aspx
[3]: https://msdn.microsoft.com/en-us/library/windows/desktop/bb762494.aspx
[4]: https://en.wikipedia.org/wiki/Special_folder
[5]: https://docs.microsoft.com/en-us/uwp/api/windows.storage.applicationdata
[6]: https://gist.github.com/mkropat/7550097
[10]: https://msdn.microsoft.com/en-us/library/s2esdf4x(v=vs.90).aspx
[11]: https://technet.microsoft.com/en-us/library/cc766489.aspx
[12]: https://blogs.msdn.microsoft.com/cjacks/2008/02/05/where-should-i-write-program-data-instead-of-program-files/
[13]: https://blogs.msdn.microsoft.com/oldnewthing/20071126-00/?p=24383/
[14]: https://arstechnica.com/civis/viewtopic.php?f=14&t=1127464
[15]: https://www.gnu.org/software/make/manual/html_node/Recursion.html

